============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-9.0.2, pluggy-1.6.0 -- D:\ReactJSLearning\Synapse\backend\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: D:\ReactJSLearning\Synapse\backend
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-1.3.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 14 items

src/modules/billing/tests/integration/test_billing_router.py::test_create_invoice_manual PASSED [  7%]
src/modules/billing/tests/integration/test_billing_router.py::test_get_invoice_detail PASSED [ 14%]
src/modules/billing/tests/integration/test_billing_router.py::test_process_payment PASSED [ 21%]
src/modules/warranty/tests/integration/test_warranty_router.py::test_create_warranty_ticket PASSED [ 28%]
src/modules/warranty/tests/integration/test_warranty_router.py::test_list_warranty_tickets PASSED [ 35%]
src/modules/warranty/tests/integration/test_warranty_router.py::test_update_warranty_status PASSED [ 42%]
src/modules/promotions/tests/integration/test_promotions_router.py::test_create_promotion PASSED [ 50%]
src/modules/promotions/tests/integration/test_promotions_router.py::test_validate_promotion_code PASSED [ 57%]
src/modules/promotions/tests/integration/test_promotions_router.py::test_list_promotions PASSED [ 64%]
src/modules/operating_hours/tests/integration/test_operating_hours_router.py::test_get_week_operating_hours PASSED [ 71%]
src/modules/operating_hours/tests/integration/test_operating_hours_router.py::test_create_exception_date PASSED [ 78%]
src/modules/operating_hours/tests/integration/test_operating_hours_router.py::test_list_exception_dates PASSED [ 85%]
src/modules/notifications/tests/integration/test_notifications_router.py::test_list_templates FAILED [ 92%]
src/modules/notifications/tests/integration/test_notifications_router.py::test_send_test_email FAILED [100%]

================================== FAILURES ===================================
_____________________________ test_list_templates _____________________________

client = <httpx.AsyncClient object at 0x000002C1175344A0>
mock_session = <AsyncMock id='3028343388640'>

    @pytest.mark.asyncio
    async def test_list_templates(client: AsyncClient, mock_session):
        """Test l\u1ea5y danh s\xe1ch template."""
        mock_tpl = NotificationTemplate(
            id=uuid.uuid4(),
            code="WELCOME",
            subject="Ch\xe0o m\u1eebng",
            body="Hello {{name}}"
        )
    
        mock_result = MagicMock()
        mock_result.all.return_value = [mock_tpl]
        mock_session.exec.return_value = mock_result
    
>       response = await client.get("/api/v1/notifications/templates")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

src\modules\notifications\tests\integration\test_notifications_router.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
venv\Lib\site-packages\httpx\_client.py:1768: in get
    return await self.request(
venv\Lib\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
venv\Lib\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv\Lib\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv\Lib\site-packages\fastapi\applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
venv\Lib\site-packages\starlette\applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
venv\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
C:\Users\Dell\AppData\Local\Programs\Python\Python312\Lib\contextlib.py:158: in __exit__
    self.gen.throw(value)
venv\Lib\site-packages\starlette\_utils.py:85: in collapse_excgroups
    raise exc
venv\Lib\site-packages\starlette\middleware\base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\app\middleware.py:58: in dispatch
    raise e
src\app\middleware.py:23: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\middleware\base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv\Lib\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
venv\Lib\site-packages\fastapi\routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\fastapi\routing.py:111: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fastapi\routing.py:391: in app
    raw_response = await run_endpoint_function(
venv\Lib\site-packages\fastapi\routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\modules\notifications\router.py:21: in list_templates
    return await service.list_templates()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.modules.notifications.service.NotificationService object at 0x000002C1172EEA20>

    async def list_templates(self) -> list[NotificationTemplateRead]:
        result = await self.session.exec(select(NotificationTemplate))
>       return [NotificationTemplateRead.model_validate(t) for t in result.all()]
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 3 validation errors for NotificationTemplateRead
E       name
E         Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
E           For further information visit https://errors.pydantic.dev/2.12/v/string_type
E       subject_template
E         Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
E           For further information visit https://errors.pydantic.dev/2.12/v/string_type
E       body_template
E         Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
E           For further information visit https://errors.pydantic.dev/2.12/v/string_type

src\modules\notifications\service.py:31: ValidationError
---------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-12-22T08:39:26.330954+00:00", "level": "ERROR", "message": "Request failed: GET /api/v1/notifications/templates", "logger": "synapse", "request_id": "9477964e-980f-4b4b-bf48-a7f8dc8ada4b", "exception": "Traceback (most recent call last):\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\src\\app\\middleware.py\", line 23, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 125, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 111, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 391, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 290, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\src\\modules\\notifications\\router.py\", line 21, in list_templates\n    return await service.list_templates()\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\src\\modules\\notifications\\service.py\", line 31, in list_templates\n    return [NotificationTemplateRead.model_validate(t) for t in result.all()]\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\pydantic\\main.py\", line 716, in model_validate\n    return cls.__pydantic_validator__.validate_python(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\npydantic_core._pydantic_core.ValidationError: 3 validation errors for NotificationTemplateRead\nname\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nsubject_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nbody_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type", "method": "GET", "path": "/api/v1/notifications/templates", "duration": 0.0015, "error": "3 validation errors for NotificationTemplateRead\nname\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nsubject_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nbody_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type"}
{"timestamp": "2025-12-22T08:39:26.334046+00:00", "level": "ERROR", "message": "Global Exception: 3 validation errors for NotificationTemplateRead\nname\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nsubject_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nbody_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type", "logger": "synapse", "request_id": "", "exception": "Traceback (most recent call last):\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Dell\\AppData\\Local\\Programs\\Python\\Python312\\Lib\\contextlib.py\", line 158, in __exit__\n    self.gen.throw(value)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\src\\app\\middleware.py\", line 58, in dispatch\n    raise e\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\src\\app\\middleware.py\", line 23, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 125, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 111, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 391, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\fastapi\\routing.py\", line 290, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\src\\modules\\notifications\\router.py\", line 21, in list_templates\n    return await service.list_templates()\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\src\\modules\\notifications\\service.py\", line 31, in list_templates\n    return [NotificationTemplateRead.model_validate(t) for t in result.all()]\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"D:\\ReactJSLearning\\Synapse\\backend\\venv\\Lib\\site-packages\\pydantic\\main.py\", line 716, in model_validate\n    return cls.__pydantic_validator__.validate_python(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\npydantic_core._pydantic_core.ValidationError: 3 validation errors for NotificationTemplateRead\nname\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nsubject_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type\nbody_template\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type"}
____________________________ test_send_test_email _____________________________

client = <httpx.AsyncClient object at 0x000002C117498860>
mock_admin_auth = {'email': 'admin@synapse.com', 'full_name': 'Admin Test', 'role': 'admin', 'sub': '64d2c304-3936-4225-bfc1-1ab4b33209d5'}

    @pytest.mark.asyncio
    async def test_send_test_email(client: AsyncClient, mock_admin_auth):
        """Test API send email."""
        # Service implementation might use external providers, but we test the endpoint
        data = {
            "to_email": "user@test.com",
            "subject": "Test",
            "body": "Content"
        }
    
        response = await client.post("/api/v1/notifications/send-email", json=data)
>       assert response.status_code == 200
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

src\modules\notifications\tests\integration\test_notifications_router.py:41: AssertionError
---------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-12-22T08:39:26.643237+00:00", "level": "INFO", "message": "POST /api/v1/notifications/send-email - 422", "logger": "synapse", "request_id": "845a694d-e1a2-4753-8ef2-1fd3468e83dd", "method": "POST", "path": "/api/v1/notifications/send-email", "status_code": 422, "duration": 0.0061, "client_ip": "127.0.0.1"}
=========================== short test summary info ===========================
FAILED src/modules/notifications/tests/integration/test_notifications_router.py::test_list_templates - pydantic_core._pydantic_core.ValidationError: 3 validation errors for NotificationTemplateRead
name
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.12/v/string_type
subject_template
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.12/v/string_type
body_template
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.12/v/string_type
FAILED src/modules/notifications/tests/integration/test_notifications_router.py::test_send_test_email - assert 422 == 200
 +  where 422 = <Response [422 Unprocessable Entity]>.status_code
======================== 2 failed, 12 passed in 0.58s =========================
